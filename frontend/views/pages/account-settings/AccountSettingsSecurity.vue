<script lang="ts" setup>
import PasswordConfirmationDialog from '@/components/dialogs/PasswordConfirmationDialog.vue'
import laptopGirl from '@images/illustrations/laptop-girl.png'
import { useApi } from '@/composables/useApi'

const isCurrentPasswordVisible = ref(false)
const isNewPasswordVisible = ref(false)
const isConfirmPasswordVisible = ref(false)
const currentPassword = ref('')
const newPassword = ref('')
const confirmPassword = ref('')

// Ë°®ÂñÆÈ©óË≠âÁãÄÊÖã
const formErrors = ref({
  currentPassword: '',
  newPassword: '',
  confirmPassword: '',
  general: ''
})

// ËºâÂÖ•ÁãÄÊÖã
const isLoading = ref(false)

// ÊàêÂäüË®äÊÅØ
const successMessage = ref('')

// TOTP ÁãÄÊÖã
const totpStatus = ref<{
  totpEnabled: boolean
  backupCodes?: string[]
} | null>(null)
const isLoadingTotpStatus = ref(false)

const passwordRequirements = [
  'Ëá≥Â∞ë8ÂÄãÂ≠óÂÖÉ',
  'Ëá≥Â∞ë‰∏ÄÂÄãÂ∞èÂØ´Â≠óÊØç',
  'Ëá≥Â∞ë‰∏ÄÂÄãÊï∏Â≠ó, Á¨¶Ëôü, ÊàñÁ©∫ÁôΩÂ≠óÂÖÉ',
]

// Áç≤ÂèñÁî®Êà∂Ë≥áÊñôÔºàÂåÖÊã¨ TOTP ÁãÄÊÖãÔºâ
const fetchUserProfile = async () => {
  try {
    isLoadingTotpStatus.value = true
    
    const { data, error } = await useApi('/auth/profile')
    
    if (error.value) {
      console.error('Áç≤ÂèñÁî®Êà∂Ë≥áÊñôÂ§±Êïó:', error.value)
      return
    }
    
    const responseData = data.value as any

    // API ÂõûÊáâÁöÑË≥áÊñôÂú® data.value.data ‰∏≠
    if (responseData && responseData.data) {
      const userData = responseData.data
      totpStatus.value = {
        totpEnabled: userData.totpEnabled || false,
        backupCodes: userData.backupCodes || []
      }
    }
  } catch (err) {
    console.error('Áç≤ÂèñÁî®Êà∂Ë≥áÊñôÈåØË™§:', err)
  } finally {
    isLoadingTotpStatus.value = false
  }
}

// ÂØÜÁ¢ºÂº∑Â∫¶È©óË≠â
const validatePassword = (password: string) => {
  const errors = []
  if (password.length < 8) errors.push('ÂØÜÁ¢ºËá≥Â∞ëÈúÄË¶Å8ÂÄãÂ≠óÂÖÉ')
  if (!/[a-z]/.test(password)) errors.push('ÂØÜÁ¢ºÈúÄË¶ÅÂåÖÂê´Ëá≥Â∞ë‰∏ÄÂÄãÂ∞èÂØ´Â≠óÊØç')
  if (!/[0-9!@#$%^&*(),.?":{}|<> ]/.test(password)) errors.push('ÂØÜÁ¢ºÈúÄË¶ÅÂåÖÂê´Ëá≥Â∞ë‰∏ÄÂÄãÊï∏Â≠ó„ÄÅÁ¨¶ËôüÊàñÁ©∫ÁôΩÂ≠óÂÖÉ')
  return errors
}

// Ë°®ÂñÆÈ©óË≠â
const validateForm = () => {
  formErrors.value = {
    currentPassword: '',
    newPassword: '',
    confirmPassword: '',
    general: ''
  }

  let isValid = true

  // È©óË≠âÁï∂ÂâçÂØÜÁ¢º
  if (!currentPassword.value) {
    formErrors.value.currentPassword = 'Ë´ãËº∏ÂÖ•Áï∂ÂâçÂØÜÁ¢º'
    isValid = false
  }

  // È©óË≠âÊñ∞ÂØÜÁ¢º
  if (!newPassword.value) {
    formErrors.value.newPassword = 'Ë´ãËº∏ÂÖ•Êñ∞ÂØÜÁ¢º'
    isValid = false
  } else {
    const passwordErrors = validatePassword(newPassword.value)
    if (passwordErrors.length > 0) {
      formErrors.value.newPassword = passwordErrors.join(', ')
      isValid = false
    }
  }

  // È©óË≠âÁ¢∫Ë™çÂØÜÁ¢º
  if (!confirmPassword.value) {
    formErrors.value.confirmPassword = 'Ë´ãÁ¢∫Ë™çÊñ∞ÂØÜÁ¢º'
    isValid = false
  } else if (newPassword.value !== confirmPassword.value) {
    formErrors.value.confirmPassword = 'Á¢∫Ë™çÂØÜÁ¢ºËàáÊñ∞ÂØÜÁ¢º‰∏çÁ¨¶'
    isValid = false
  }

  return isValid
}

// ‰øÆÊîπÂØÜÁ¢º
const changePassword = async () => {
  if (!validateForm()) return

  isLoading.value = true
  formErrors.value.general = ''
  successMessage.value = ''

  try {
    const { data, error } = await useApi('/auth/change-password', {
      method: 'POST',
      body: {
        currentPassword: currentPassword.value,
        newPassword: newPassword.value
      }
    })

    if (error.value) {
      // ËôïÁêÜÈåØË™§ÂõûÊáâ
      const errorData = error.value.data
      if (errorData && errorData.message) {
        formErrors.value.general = errorData.message
      } else {
        formErrors.value.general = '‰øÆÊîπÂØÜÁ¢ºÂ§±ÊïóÔºåË´ãÂÜçË©¶‰∏ÄÊ¨°'
      }
      return
    }

    // ÊàêÂäü
    successMessage.value = 'ÂØÜÁ¢º‰øÆÊîπÊàêÂäüÔºÅ'
    
    // Ê∏ÖÁ©∫Ë°®ÂñÆ
    currentPassword.value = ''
    newPassword.value = ''
    confirmPassword.value = ''
    
    // 3ÁßíÂæåÊ∏ÖÈô§ÊàêÂäüË®äÊÅØ
    setTimeout(() => {
      successMessage.value = ''
    }, 3000)

  } catch (err) {
    console.error('‰øÆÊîπÂØÜÁ¢ºÈåØË™§:', err)
    formErrors.value.general = '‰øÆÊîπÂØÜÁ¢ºÂ§±ÊïóÔºåË´ãÂÜçË©¶‰∏ÄÊ¨°'
  } finally {
    isLoading.value = false
  }
}

// ÈáçÁΩÆË°®ÂñÆ
const resetForm = () => {
  currentPassword.value = ''
  newPassword.value = ''
  confirmPassword.value = ''
  formErrors.value = {
    currentPassword: '',
    newPassword: '',
    confirmPassword: '',
    general: ''
  }
  successMessage.value = ''
}

// TOTP Áõ∏Èóú
const isOneTimePasswordDialogVisible = ref(false)
const isPasswordConfirmationDialogVisible = ref(false)

// ËôïÁêÜ TOTP ÂïüÁî®ÊàêÂäü
const handleTotpEnabled = (backupCodes: string[]) => {
  // Êõ¥Êñ∞ TOTP ÁãÄÊÖã
  totpStatus.value = {
    totpEnabled: true,
    backupCodes: backupCodes
  }
  
  // ÈóúÈñâÂ∞çË©±Ê°Ü
  isOneTimePasswordDialogVisible.value = false
}

// Á¶ÅÁî® TOTP
const disableTotp = async (password: string) => {
  try {
    const { error } = await useApi('/auth/totp/disable', {
      method: 'POST',
      body: { password },
      skipGlobalErrorHandler: true,
    } as any)

    if (error.value) {
      // Êú¨Âú∞ËôïÁêÜÈåØË™§ÔºåËÄå‰∏çÊòØËß∏ÁôºÂÖ®ÂüüÁôªÂá∫
      alert(error.value.data?.message || 'Á¶ÅÁî®ÈõôÂõ†Á¥†È©óË≠âÂ§±ÊïóÔºåË´ãÊ™¢Êü•ÊÇ®ÁöÑÂØÜÁ¢º„ÄÇ')

      return
    }

    // Êõ¥Êñ∞ÁãÄÊÖã
    totpStatus.value = {
      totpEnabled: false,
      backupCodes: [],
    }

    alert('ÈõôÂõ†Á¥†È©óË≠âÂ∑≤Á¶ÅÁî®')
  }
  catch (err) {
    console.error('Á¶ÅÁî® TOTP ÈåØË™§:', err)
    alert('Á¶ÅÁî®ÈõôÂõ†Á¥†È©óË≠âÂ§±Êïó')
  }
}

const openPasswordConfirmationDialog = () => {
  isPasswordConfirmationDialogVisible.value = true
}

// È†ÅÈù¢ËºâÂÖ•ÊôÇÁç≤ÂèñÁî®Êà∂Ë≥áÊñô
onMounted(() => {
  // Ê™¢Êü• session ÁãÄÊÖã
  const { data: session } = useAuth()
  console.log('Session ÁãÄÊÖã:', session.value)
  console.log('Backend Token:', session.value?.backendToken)
  
  fetchUserProfile()
})

const recentDevicesHeaders = [
  { title: 'BROWSER', key: 'browser' },
  { title: 'DEVICE', key: 'device' },
  { title: 'LOCATION', key: 'location' },
  { title: 'RECENT ACTIVITY', key: 'recentActivity' },
]

const recentDevices = [
  {
    browser: 'Chrome on Windows',
    device: 'HP Spectre 360',
    location: 'New York, NY',
    recentActivity: '28 Apr 2022, 18:20',
    deviceIcon: { icon: 'tabler-brand-windows', color: 'primary' },
  },
  {
    browser: 'Chrome on iPhone',
    device: 'iPhone 12x',
    location: 'Los Angeles, CA',
    recentActivity: '20 Apr 2022, 10:20',
    deviceIcon: { icon: 'tabler-device-mobile', color: 'error' },
  },
  {
    browser: 'Chrome on Android',
    device: 'Oneplus 9 Pro',
    location: 'San Francisco, CA',
    recentActivity: '16 Apr 2022, 04:20',
    deviceIcon: { icon: 'tabler-brand-android', color: 'success' },
  },
  {
    browser: 'Chrome on macOS',
    device: 'Apple iMac',
    location: 'New York, NY',
    recentActivity: '28 Apr 2022, 18:20',
    deviceIcon: { icon: 'tabler-brand-apple', color: 'secondary' },
  },
  {
    browser: 'Chrome on Windows',
    device: 'HP Spectre 360',
    location: 'Los Angeles, CA',
    recentActivity: '20 Apr 2022, 10:20',
    deviceIcon: { icon: 'tabler-brand-windows', color: 'primary' },
  },
  {
    browser: 'Chrome on Android',
    device: 'Oneplus 9 Pro',
    location: 'San Francisco, CA',
    recentActivity: '16 Apr 2022, 04:20',
    deviceIcon: { icon: 'tabler-brand-android', color: 'success' },
  },
]
</script>

<template>
  <VRow>
    <!-- SECTION: Change Password -->
    <VCol cols="12">
      <VCard title="ÂØÜÁ¢º‰øÆÊîπ">
        <!-- ÊàêÂäüË®äÊÅØ -->
        <VAlert
          v-if="successMessage"
          type="success"
          variant="tonal"
          closable
          class="ma-4"
        >
          {{ successMessage }}
        </VAlert>

        <!-- ‰∏ÄËà¨ÈåØË™§Ë®äÊÅØ -->
        <VAlert
          v-if="formErrors.general"
          type="error"
          variant="tonal"
          closable
          class="ma-4"
        >
          {{ formErrors.general }}
        </VAlert>

        <VForm @submit.prevent="changePassword">
          <VCardText class="pt-0">
            <!-- üëâ Current Password -->
            <VRow>
              <VCol
                cols="12"
                md="6"
              >
                <!-- üëâ current password -->
                <AppTextField
                  v-model="currentPassword"
                  :type="isCurrentPasswordVisible ? 'text' : 'password'"
                  :append-inner-icon="isCurrentPasswordVisible ? 'tabler-eye-off' : 'tabler-eye'"
                  label="ËàäÂØÜÁ¢º"
                  autocomplete="current-password"
                  placeholder="¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑"
                  :error-messages="formErrors.currentPassword"
                  @click:append-inner="isCurrentPasswordVisible = !isCurrentPasswordVisible"
                />
              </VCol>
            </VRow>

            <!-- üëâ New Password -->
            <VRow>
              <VCol
                cols="12"
                md="6"
              >
                <!-- üëâ new password -->
                <AppTextField
                  v-model="newPassword"
                  :type="isNewPasswordVisible ? 'text' : 'password'"
                  :append-inner-icon="isNewPasswordVisible ? 'tabler-eye-off' : 'tabler-eye'"
                  label="Êñ∞ÂØÜÁ¢º"
                  autocomplete="new-password"
                  placeholder="¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑"
                  :error-messages="formErrors.newPassword"
                  @click:append-inner="isNewPasswordVisible = !isNewPasswordVisible"
                />
              </VCol>

              <VCol
                cols="12"
                md="6"
              >
                <!-- üëâ confirm password -->
                <AppTextField
                  v-model="confirmPassword"
                  :type="isConfirmPasswordVisible ? 'text' : 'password'"
                  :append-inner-icon="isConfirmPasswordVisible ? 'tabler-eye-off' : 'tabler-eye'"
                  label="Á¢∫Ë™çÊñ∞ÂØÜÁ¢º"
                  autocomplete="new-password"
                  placeholder="¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑¬∑"
                  :error-messages="formErrors.confirmPassword"
                  @click:append-inner="isConfirmPasswordVisible = !isConfirmPasswordVisible"
                />
              </VCol>
            </VRow>
          </VCardText>

          <!-- üëâ Password Requirements -->
          <VCardText>
            <h6 class="text-h6 text-medium-emphasis mb-4">
              ÂØÜÁ¢ºÂÆâÂÖ®Ë¶ÅÊ±Ç:
            </h6>

            <VList class="card-list">
              <VListItem
                v-for="item in passwordRequirements"
                :key="item"
                :title="item"
                class="text-medium-emphasis"
              >
                <template #prepend>
                  <VIcon
                    size="10"
                    icon="tabler-circle-filled"
                  />
                </template>
              </VListItem>
            </VList>
          </VCardText>

          <!-- üëâ Action Buttons -->
          <VCardText class="d-flex flex-wrap gap-4">
            <VBtn
              type="submit"
              :loading="isLoading"
              :disabled="isLoading"
            >
              {{ isLoading ? '‰øÆÊîπ‰∏≠...' : 'ÂÑ≤Â≠òËÆäÊõ¥' }}
            </VBtn>

            <VBtn
              type="button"
              color="secondary"
              variant="tonal"
              :disabled="isLoading"
              @click="resetForm"
            >
              ÈáçÁΩÆ
            </VBtn>
          </VCardText>
        </VForm>
      </VCard>
    </VCol>
    <!-- !SECTION -->

    <!-- SECTION Two-steps verification -->
    <VCol cols="12">
      <VCard title="ÈõôÂõ†Á¥†È©óË≠â">
        <VCardText>
          <!-- ËºâÂÖ•‰∏≠ -->
          <div v-if="isLoadingTotpStatus" class="d-flex justify-center mb-4">
            <VProgressCircular
              indeterminate
              color="primary"
            />
          </div>

          <!-- TOTP Â∑≤ÂïüÁî® -->
          <div v-else-if="totpStatus?.totpEnabled">
            <VAlert
              type="success"
              variant="tonal"
              class="mb-4"
            >
              <template #title>ÈõôÂõ†Á¥†È©óË≠âÂ∑≤ÂïüÁî®</template>
              <template #text>
                ÊÇ®ÁöÑÂ∏≥Êà∂Â∑≤ÂèóÂà∞ÈõôÂõ†Á¥†È©óË≠â‰øùË≠∑„ÄÇÁôªÂÖ•ÊôÇÈúÄË¶ÅÂØÜÁ¢ºÂíåÈ©óË≠âÁ¢º„ÄÇ
              </template>
            </VAlert>

            <div class="d-flex gap-4">
              <VBtn
                color="error"
                variant="tonal"
                @click="openPasswordConfirmationDialog"
              >
                Á¶ÅÁî®ÈõôÂõ†Á¥†È©óË≠â
              </VBtn>
            </div>
          </div>

          <!-- TOTP Êú™ÂïüÁî® -->
          <div v-else>
            <h5 class="text-h5 text-medium-emphasis mb-4">
              ÂÖ©Ê≠•È©üÈ©óË≠âÂ∞öÊú™ÂïüÁî®„ÄÇ
            </h5>
            <p class="mb-6">
              ÂÖ©Ê≠•È©üÈ©óË≠âÂèØ‰ª•Â¢ûÂä†Â∏≥ËôüÁöÑÂÆâÂÖ®ÊÄßÔºåÈúÄË¶ÅÂØÜÁ¢ºÂíåÈ©óË≠âÁ¢ºÊâçËÉΩÁôªÂÖ•„ÄÇ
              <a
                href="javascript:void(0)"
                class="text-decoration-none"
              >Learn more.</a>
            </p>

            <VBtn @click="isOneTimePasswordDialogVisible = true">
              ÂïüÁî®ÂÖ©Ê≠•È©üÈ©óË≠â
            </VBtn>
          </div>
        </VCardText>
      </VCard>
    </VCol>
    <!-- !SECTION -->

    <!-- SECTION Recent Devices -->
    <!-- <VCol cols="12">
      <!-- üëâ Table -->
      <!-- <VCard title="Recent Devices">
        <VDivider />

        <VDataTable
          :headers="recentDevicesHeaders"
          :items="recentDevices"
          hide-default-footer
          class="text-no-wrap"
        >
          <template #item.browser="{ item }">
            <div class="d-flex">
              <VIcon
                start
                size="22"
                :icon="item.deviceIcon.icon"
                :color="item.deviceIcon.color"
              />
              <div class="text-high-emphasis text-body-1 font-weight-medium">
                {{ item.browser }}
              </div>
            </div>
          </template>
        </VDataTable>
      </VCard>
    </VCol>
    <!-- !SECTION -->
  </VRow>

  <!-- SECTION Enable One time password -->
  <TwoFactorAuthDialog 
    v-model:is-dialog-visible="isOneTimePasswordDialogVisible" 
    @totp-enabled="handleTotpEnabled"
  />
  <!-- !SECTION -->

  <!-- SECTION Password Confirmation Dialog -->
  <PasswordConfirmationDialog
    v-model:is-dialog-visible="isPasswordConfirmationDialogVisible"
    @confirm="disableTotp"
  />
</template>

<style lang="scss" scoped>
.card-list {
  --v-card-list-gap: 16px;
}

.server-close-btn {
  inset-inline-end: 0.5rem;
}
</style>
